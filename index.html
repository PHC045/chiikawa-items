<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>商品一覽</title>

<!-- ====== 版面樣式（可以直接用） ====== -->
<style>
:root{
  --bg:#fafafa; --card:#fff; --text:#111; --muted:#777; --ring:#e7e7e7; --accent:#d33;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial}
.topbar{
  position:sticky;top:0;z-index:10;background:var(--card);
  padding:10px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;
  box-shadow:0 2px 4px rgba(0,0,0,.06);
}
input,select{padding:6px 10px;border:1px solid var(--ring);border-radius:8px;background:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;padding:16px}

.card{background:var(--card);border:1px solid var(--ring);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.card img{width:100%;height:220px;object-fit:contain;background:#fff;display:block}
.body{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
.cat{font-size:12px;color:var(--muted)}
.title{font-weight:700;margin:0}
.price{color:var(--accent);font-weight:700}
.meta{font-size:12px;color:#999}

/* 讓價格固定置底（不同名稱長度也對齊） */
.price-row{margin-top:auto;display:flex;justify-content:space-between;align-items:center}

/* 小裝置優化 */
@media (max-width: 420px){
  .card img{height:200px}
}
</style>
</head>
<body>

<!-- 篩選工具列 -->
<div class="topbar">
  <select id="cat"><option value="">全部分類</option></select>
  <input id="kw" placeholder="搜尋商品…" />
  <select id="sort">
    <option value="new">最新上架</option>
    <option value="priceLow">價錢↑</option>
    <option value="priceHigh">價錢↓</option>
  </select>
</div>

<!-- 卡片容器 -->
<div id="grid" class="grid"></div>

<!-- 如果你是把 JSON 放在這：保留這個外框（內容由你的系統產生） -->
<!--
<script id="data" type="application/json">
[ {"category":"usagi","image":"image001.png","name":"商品A","price":50}, ... ]
</script>
-->

<!-- ====== 主程式（可直接用） ====== -->
<script>
/* 讀取 DATA：支援 <script id="data"> 或 window.DATA */
const DATA = (() => {
  const el = document.getElementById('data');
  if (el) {
    try { return JSON.parse(el.textContent).map((x,i)=>({...x,_i:i})); }
    catch(e){ console.error('DATA 解析失敗', e); return []; }
  }
  if (Array.isArray(window.DATA)) return window.DATA.map((x,i)=>({...x,_i:i}));
  console.warn('找不到 DATA，頁面將無資料'); 
  return [];
})();

/* 可選：是否用 jsDelivr（true=用 CDN；false=用站內 assets/img） */
const USE_CDN = false;
/* 你的 GitHub 路徑：user/repo（已放你正在用的） */
const GH_USER = 'animegoodspotato';
const GH_REPO = 'chiikawa-items';
const CDN = (f) => `https://cdn.jsdelivr.net/gh/${GH_USER}/${GH_REPO}@main/assets/img/${f}`;
const LOC = (f) => `assets/img/${f}`;

/* 懶載入（單一 Observer） */
const PIXEL = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
const imgObserver = 'IntersectionObserver' in window
  ? new IntersectionObserver((entries, ob) => {
      entries.forEach(e=>{
        if(!e.isIntersecting) return;
        const img=e.target;
        const real = img.getAttribute('data-src');
        if (real) {
          img.src = real;
          img.removeAttribute('data-src');
        }
        ob.unobserve(img);
      });
    }, {rootMargin:'600px 0px', threshold:0.01})
  : null;

function prepareLazy(imgEl, file){
  const real = (USE_CDN ? CDN(file) : LOC(file));
  imgEl.loading = 'lazy';
  imgEl.decoding = 'async';
  imgEl.src = PIXEL;                 // 先放 1×1 佔位
  imgEl.setAttribute('data-src', real);
  if (imgObserver) imgObserver.observe(imgEl);
  else { imgEl.src = real; imgEl.removeAttribute('data-src'); } // 舊瀏覽器降級
}

/* 產卡片 */
function render(list){
  const g = document.getElementById('grid');
  g.innerHTML = '';

  list.forEach(x=>{
    const card = document.createElement('div');
    card.className = 'card';

    const img = document.createElement('img');
    prepareLazy(img, x.image);
    img.alt = x.name || '商品';
    img.onerror = () => { img.style.objectFit='contain'; img.style.background='#fff'; };

    const body = document.createElement('div');
    body.className = 'body';
    body.innerHTML = `
      <div class="cat">${x.category || '未分類'}</div>
      <div class="title">${x.name || '（未命名）'}</div>
      <div class="price-row">
        <div class="price">MOP ${Number(x.price||0).toFixed(2)}</div>
      </div>
    `;

    card.appendChild(img);
    card.appendChild(body);
    g.appendChild(card);
  });
}

/* 初始化：分類/搜尋/排序 */
(function init(){
  // 分類選單
  const cats = [...new Set(DATA.map(d => d.category || '未分類'))].sort();
  const selCat = document.getElementById('cat');
  cats.forEach(c=>{
    const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o);
  });

  const kw   = document.getElementById('kw');
  const sort = document.getElementById('sort');

  function apply(){
    const catVal = selCat.value.trim();
    const kwVal  = kw.value.trim().toLowerCase();

    let list = DATA.filter(x=>{
      const catOK = !catVal || (x.category || '未分類') === catVal;
      const key   = ((x.name||'') + ' ' + (x.image||'')).toLowerCase();
      const kwOK  = !kwVal || key.includes(kwVal);
      return catOK && kwOK;
    });

    if (sort.value === 'priceLow')  list.sort((a,b)=>(+a.price||0)-(+b.price||0));
    if (sort.value === 'priceHigh') list.sort((a,b)=>(+b.price||0)-(+a.price||0));
    if (sort.value === 'new')       list.sort((a,b)=>(b._i||0)-(a._i||0)); // 以出現順序視為新舊

    render(list);
  }

  selCat.addEventListener('change', apply);
  kw.addEventListener('input', apply);
  sort.addEventListener('change', apply);

  // 首次顯示
  render(DATA);
})();
</script>
</body>
</html>
